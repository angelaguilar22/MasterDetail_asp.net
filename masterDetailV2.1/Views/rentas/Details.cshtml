@model masterDetailV2._1.Models.rentas

@{
    ViewBag.Title = "Details";
}

<h2>Details</h2>

<!-- INICIO DE SECCION DE SCRIPTS -->
<script src="~/Scripts/jquery-3.3.1.min.js"></script>
<script src="~/Scripts/bootstrap.min.js"></script>
<link href="~/Content/bootstrap.min.css" rel="stylesheet" />
<script src="~/Scripts/jquery.validate.min.js"></script>


<!-- INICIO DE LINKS Y SCRIPTS DE SWAL ALERT-->
<link href="~/Content/sweetalert.css" rel="stylesheet" />
<script src="~/Scripts/sweetalert.min.js" type="text/javascript"></script>

<div>
    <h4>rentas</h4>
    <hr />
    <dl class="dl-horizontal">
        <dt>
            @Html.DisplayNameFor(model => model.folio)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.folio)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.fechaCreacion)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.fechaCreacion)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.fechaModificacion)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.fechaModificacion)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.fechaRenta)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.fechaRenta)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.fechaVence)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.fechaVence)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.subtotal)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.subtotal)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.total)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.total)
        </dd>

        <dt>
            @Html.DisplayNameFor(model => model.cantidadTotalProd)
        </dt>

        <dd>
            @Html.DisplayFor(model => model.cantidadTotalProd)
        </dd>


    </dl>

    <div class="col-md-12">

    </div>
</div>
<p>
    @Html.ActionLink("Edit", "Edit", new { id = Model.id }) |
    @Html.ActionLink("Back to List", "Index")
</p>

<div class="col-md-12" style="margin-top: 30px; padding-left: 15px; padding-right: 15px;">
    <a href="#" class="btn btn-default" onclick="addProducto(0)" style="margin-top: 30px; float: right"><span class='glyphicon glyphicon-plus'></span></a>

    <table class="table table-striped" style="margin-top: 20px">
        <thead>
            <tr>
                <th>Nombre</th>
                <th>Descripción</th>
                <th>Marca</th>
                <th>Numero de Serie</th>
                <th>Estado Fisico</th>
                <th>Precio Unitario</th>
                <th>Cantidad</th>
                <th>Unidad de Medida</th>
                <th>Categoria</th>
                <th>Entregado</th>
            </tr>

        </thead>
        <tbody id="produtosList">
            <!--     inicio de seccion de listado de PRODUCTOS -->
            <tr id="loadingStatus"></tr>
        </tbody>
    </table>
</div>




<script type="text/javascript">
    // Funcion ejecutada cuando esta listo el HTML
    $(document).ready(function () {
        let idRenta = '@ViewBag.idRenta';

        // Cargar informacion del Detalle de la renta
        cargarGrid(idRenta);

        // Funcion para cargar informacion a la GRID
        function cargarGrid(idRenta) {
            let listadoProductos = [];

            $.ajax({
                url: 'http://localhost:50131/rentas/getDetallesRecepcion?idRenta=' + idRenta,
                success: function (respuesta) {
                    console.log(respuesta);
                    // Cargamos los elementos a el listado de productos
                    listadoProductos = respuesta;


                    // Lmpeamos la GRID
                    $("#produtosList").html('');

                    // Objeto a enviar listado de Productos
                    var SetData = $("#produtosList");

                    // Generamosla GRID dinamicamente
                    listadoProductos.forEach(producto => {

                        // Generamos el elemento html a agregar a la GRID
                        var Data = "<tr class='row_" + producto.id + "'>" +
                            "<td>" + producto.nombre + "</td>" +
                            "<td>" + producto.descripcion + "</td>" +
                            "<td>" + producto.marca + "</td>" +
                            "<td>" + producto.numeroSerie + "</td>" +
                            "<td>" + producto.estadoFisico + "</td>" +
                            "<td>" + producto.precioUnitario + "</td>" +
                            "<td>" + producto.cantidad + "</td>" +
                            "<td>" + producto.unidadMedida + "</td>" +
                            "<td>" + producto.categoria + "</td>" +
                            "<td>" + producto.entregado + "</td>" +
                            "<td>" + "<a href='#' class='btn btn-primary' onclick='recibirProducto(" + producto.id +"," +idRenta + ")' >Recibir</a>" + "</td>" +
                            "</tr>";

                        // Cuerpo de la GRID
                        SetData.append(Data);
                    });
                },
                error: function () {
                    console.log("No se ha podido obtener la información");
                }
            });

        }

        
    });

    // Funcion para cambiar el estatus del detalle en el caso de recibir el producto rentad
    function recibirProducto(id, idRenta) {
        console.log(id, idRenta, 'id del detalle de la renta');

        let detalleRenta = {
            idDetalleRenta: id,
            entregado: 1
        }

        console.log(detalleRenta);

        swal({
            title: "Estas seguro de recibir el producto?",
            text: "El producto se recepcionara actualizara el estatus de entregado",
            type: "warning",
            showCancelButton: true,
            confirmButtonClass: "btn-danger",
            confirmButtonText: "Sí",
            cancelButtonText: "No",
            closeOnConfirm: false,
            closeOnCancel: false
        },
            function (isConfirm) {
                if (isConfirm) {
                    // Petion a backend para agregar la Recepcion a base de datos
                    $.ajax({
                        type: "POST",
                        url: "http://localhost:50131/rentas/actualizarDetalle",
                        data: detalleRenta,
                        //dataType: 'application/json',
                        success: function (response) {

                            // Mensaje de eliminado correctamneter
                            swal("Actualizado Correctamente", "", "success");

                            setTimeout(() => {
                                console.log(response, 'Success');
                                // Redireccionamos la pagina a el index
                                window.location = "http://localhost:50131/rentas/Details/" + idRenta;
                            }, 1500);
                        },
                        error: function (error) {
                            console.log('Algo salio mal camarita al guardar la renta', error);
                        }
                    });
                  
                } else {
                    swal("Cancelado", "", "error");
                }
            });

        

    }


</script>

